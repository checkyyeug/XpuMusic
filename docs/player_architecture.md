# XpuMusic 播放器架构图

## 1. simple_wav_player_native.exe (winmm API)

```
┌─────────────────────────────────────────────────────┐
│              simple_wav_player_native.exe           │
│                    (基于 winmm)                      │
└─────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────┐
│                   Main Flow                          │
│  ┌─────────────┐  ┌────────────┐  ┌──────────────┐  │
│  │  Parse WAV  │─▶│ PlaySoundW │─▶│   Sleep      │  │
│  │   Header    │  │   API      │  │  (blocking)  │  │
│  └─────────────┘  └────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────┐
│                 Windows Audio Stack                 │
│                                                   │
│  ┌─────────────┐                                    │
│  │ winmm.dll   │                                    │
│  │ (PlaySoundW)│                                    │
│  └─────────────┘                                    │
│         │                                         │
│         ▼                                         │
│  ┌─────────────┐                                    │
│  │  Audio HW   │  ┌──────────────┐                  │
│  │ Driver      │  │ DirectSound   │                  │
│  └─────────────┘  └──────────────┘                  │
│         │                                         │
│         ▼                                         │
│  ┌─────────────┐                                    │
│  │   Audio     │                                    │
│  │  Device     │                                    │
│  └─────────────┘                                    │
└─────────────────────────────────────────────────────┘

特点:
• 最简单的实现
• 阻塞式播放
• 使用 Windows 多媒体 API
• 无需音频处理
• 兼容性最好
```

## 2. simple_wasapi_player.exe (WASAPI)

```
┌─────────────────────────────────────────────────────┐
│              simple_wasapi_player.exe               │
│                   (基于 WASAPI)                      │
└─────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────┐
│                    Core Classes                      │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │          SimpleWASAPIPlayer                │  │
│  │                                           │  │
│  │  ┌───────────┐  ┌──────────────┐         │  │
│  │  │ load_wav  │  │ initialize   │         │  │
│  │  └───────────┘  └──────────────┘         │  │
│  │                                           │  │
│  │  ┌───────────┐  ┌──────────────┐         │  │
│  │  │   play    │  │ cleanup      │         │  │
│  │  └───────────┘  └──────────────┘         │  │
│  └─────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────┐
│                  Audio Processing                    │
│                                                   │
│  WAV Data ──► Float Conversion ──► Resampling     │
│  (16-bit)                          │                │
│                                   ▼                │
│                         ┌─────────────┐            │
│                         │ Linear      │            │
│                         │ Interpolator│            │
│                         └─────────────┘            │
│                                   │                │
│                                   ▼                │
│                           PCM 16-bit Output       │
└─────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────┐
│                WASAPI Audio Pipeline                  │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │              Playback Loop                    │  │
│  │                                           │  │
│  │  ┌─────────┐  ┌─────────────┐  ┌──────────┐ │  │
│  │  │ Get    │  │ Render      │  │ Release │ │  │
│  │  │Buffer  │─▶│ Client      │─▶│Buffer   │ │  │
│  │  └─────────┘  └─────────────┘  └──────────┘ │  │
│  │                                           │  │
│  │  ┌─────────┐                             │  │
│  │  │Sleep(10)│─────────────────────────────┘  │
│  │  └─────────┘                               │  │
│  └─────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────┐
│               Windows Audio Stack                    │
│                                                   │
│  ┌─────────────┐                                    │
│  │ AudioSys.dll │                                   │
│  │   (WASAPI)   │                                   │
│  └─────────────┘                                    │
│         │                                         │
│         ▼                                         │
│  ┌─────────────┐                                    │
│  │ Audio Engine│  ┌──────────────┐                  │
│  │ (Shared     │  │ Audio Engine │                  │
│  │  Mode)      │  │  Services)   │                  │
│  └─────────────┘  └──────────────┘                  │
│         │                                         │
│         ▼                                         │
│  ┌─────────────┐                                    │
│  │   Audio     │                                    │
│  │  Device     │                                    │
│  └─────────────┘                                    │
└─────────────────────────────────────────────────────┘

特点:
• 现代音频 API
• 低延迟
• 非阻塞播放
• 自动重采样
• 支持格式转换
• 实时音频处理
```

## 对比总结

┌────────────────────────┬─────────────────────┬─────────────────────┐
│          特性           │ simple_wav_player  │ simple_wasapi_player │
├────────────────────────┼─────────────────────┼─────────────────────┤
│ API 层级                │ 高层 (winmm)        │ 底层 (WASAPI)       │
│ 播放模式                │ 阻塞式              │ 非阻塞循环          │
│ 音频处理能力            │ 无                  │ 有                  │
│ 重采样支持              │ 无                  │ 是                  │
│ 格式转换                │ 无                  │ 是                  │
│ 延迟                    │ 较高                │ 低                  │
│ 兼容性                  │ 极好                │ 好                  │
│ 复杂度                  │ 简单                │ 中等                │
│ 控制粒度                │ 粗                  │ 细                  │
│ 停止控制                │ 不能                │ 可以                │
```

## 数据流图

### winmm 播放器数据流
```
WAV File → Parse Header → Load to Memory → PlaySoundW → Audio Device → Speakers
```

### WASAPI 播放器数据流
```
WAV File
    │
    ▼
Parse Header
    │
    ▼
Convert to Float ───► Sample Rate Converter ───► Linear Interpolator
    │                                               │
    ▼                                               ▼
16-bit PCM Conversion                          Format Conversion
    │                                               │
    ▼                                               ▼
Render Buffer ←←←← Audio Loop ←←←←←←←←←←←←←←←←←←←←←←←←←
    │
    ▼
Audio Device → Speakers
```